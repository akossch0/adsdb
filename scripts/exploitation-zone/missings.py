import pandas as pd
import numpy as np
from fancyimpute import IterativeImputer
from data_io.data_io import load_data, overwrite_data


def handle_missings(db_path: str, table_name: str, handling_function) -> None:
    """
    Load a table from a DuckDB database, perform a function on it and overwrite the table in the database.

    Args:
        db_path (str): The path to the DuckDB database.
        table_name (str): The name of the table to load.
        handling_function: The function to perform on the table.
    """
    df = load_data(db_path, table_name)
    print(df.isnull().sum())
    handling_function(df)
    overwrite_data(df, db_path, table_name)


def impute_missings(df: pd.DataFrame) -> pd.DataFrame:
    """
    Impute missing values in a dataframe based on MICE.

    Args:
        df (pd.DataFrame): The dataframe to impute.
    """
    numerical_columns = df.select_dtypes(include=[np.number]).columns
    columns_with_missing = df.columns[df.isnull().any()].tolist()
    if len(columns_with_missing) == 0:
        print("No columns with missing values found.")
        return df
    imputer = IterativeImputer()
    df[numerical_columns] = imputer.fit_transform(df[numerical_columns])
    return df


def remove_missings(df: pd.DataFrame) -> pd.DataFrame:
    """
    Remove rows with missing values from a dataframe.

    Args:
        df (pd.DataFrame): The dataframe to remove rows from.
    """
    df.dropna(inplace=True)
    return df


def run_handle_missings():
    """
    Run the handle_missings function on the education and income tables.
    """
    education_table_name = "education"
    income_table_name = "income"
    trusted_db_path = "datasets/trusted-zone/trusted.db"
    handle_missings(trusted_db_path, education_table_name, impute_missings)
    handle_missings(trusted_db_path, income_table_name, remove_missings)
