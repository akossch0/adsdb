import pandas as pd
import numpy as np
from fancyimpute import IterativeImputer
from data_io.data_io import load_data, write_data


PREPARED_EDUCATION_TABLE_NAME = "education_prepared"
PREPARED_INCOME_TABLE_NAME = "income_prepared"


def handle_missings(
    source_db_path: str,
    target_db_path: str,
    source_table_name: str,
    target_table_name: str,
    handling_function,
) -> None:
    """
    Load a table from a DuckDB database, perform a function on it and write to the table in the database.

    Args:
        source_db_path (str): The source path to the DuckDB database.
        target_db_path (str): The target path to the DuckDB database.
        source_table_name (str): The name of the source table to load the data from.
        target_table_name (str): The name of the target table to write the data to.
        handling_function: The function to perform on the table.
    """
    df = load_data(source_db_path, source_table_name)
    print(df.isnull().sum())
    handling_function(df)
    write_data(df, target_db_path, target_table_name)


def impute_missings(df: pd.DataFrame) -> pd.DataFrame:
    """
    Impute missing values in a dataframe based on MICE.

    Args:
        df (pd.DataFrame): The dataframe to impute.
    """
    numerical_columns = df.select_dtypes(include=[np.number]).columns
    columns_with_missing = df.columns[df.isnull().any()].tolist()
    if len(columns_with_missing) == 0:
        print("No columns with missing values found.")
        return df
    imputer = IterativeImputer()
    df[numerical_columns] = imputer.fit_transform(df[numerical_columns])
    return df


def remove_missings(df: pd.DataFrame) -> pd.DataFrame:
    """
    Remove rows with missing values from a dataframe.

    Args:
        df (pd.DataFrame): The dataframe to remove rows from.
    """
    df.dropna(inplace=True)
    return df


def run_handle_missings():
    """
    Run the handle_missings function on the education and income tables.
    """
    trusted_db_path = "datasets/trusted-zone/trusted.db"
    exploitation_db_path = "datasets/exploitation-zone/exploitation.db"
    handle_missings(
        trusted_db_path,
        exploitation_db_path,
        "education",
        PREPARED_EDUCATION_TABLE_NAME,
        impute_missings,
    )
    handle_missings(
        trusted_db_path,
        exploitation_db_path,
        "income",
        PREPARED_INCOME_TABLE_NAME,
        remove_missings,
    )
